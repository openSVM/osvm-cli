;; AGENT PERFORMANCE TRACKER
;; Analyzes marketplace history to build comprehensive agent leaderboard
;; Tracks: bids, wins, revenue, margins, reputation, and strategy effectiveness

(do
  (define bbs-url "http://144.124.231.40:8080")

  (log :message "")
  (log :message "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
  (log :message "â•‘         ğŸ“Š AGENT PERFORMANCE TRACKER ğŸ“Š                       â•‘")
  (log :message "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
  (log :message "")

  ;; Fetch all marketplace history
  (define resp (http-get (concatenate bbs-url "/api/boards/MARKETPLACE/posts?limit=500")))
  (define posts (get (parse-json (get resp "body")) "data"))
  (define total-posts (length posts))
  (log :message (concatenate "Analyzing " (str total-posts) " marketplace posts..."))
  (log :message "")

  ;; Agent tracking structures
  ;; We'll track these agents
  (define agents ["Aggressor" "Premium" "Competitor" "Equilibrium" "SmartTrader" "WhaleTracker" "Agent"])

  ;; Counters for each agent
  (define aggressor-bids 0) (define aggressor-wins 0) (define aggressor-delivers 0)
  (define premium-bids 0) (define premium-wins 0) (define premium-delivers 0)
  (define competitor-bids 0) (define competitor-wins 0) (define competitor-delivers 0)
  (define equilibrium-bids 0) (define equilibrium-wins 0) (define equilibrium-delivers 0)
  (define smart-bids 0) (define smart-wins 0) (define smart-delivers 0)
  (define whale-bids 0) (define whale-wins 0) (define whale-delivers 0)
  (define agent-bids 0) (define agent-wins 0) (define agent-delivers 0)

  ;; Global counters
  (define total-requests 0)
  (define total-bids 0)
  (define total-accepts 0)
  (define total-delivers 0)

  ;; Analyze each post
  (for (post posts)
    (do
      (define msg (get post "body"))
      (if (null? msg) null
          (do
            (define msg-upper (upper msg))

            ;; Count message types
            (if (string-contains msg-upper "REQUEST")
                (set! total-requests (+ total-requests 1))
                null)

            (if (string-contains msg-upper "ACCEPT")
                (set! total-accepts (+ total-accepts 1))
                null)

            ;; Count BIDs per agent
            (if (string-contains msg-upper "BID")
                (do
                  (set! total-bids (+ total-bids 1))
                  (if (string-contains msg "Aggressor") (set! aggressor-bids (+ aggressor-bids 1)) null)
                  (if (string-contains msg "Premium") (set! premium-bids (+ premium-bids 1)) null)
                  (if (string-contains msg "Competitor") (set! competitor-bids (+ competitor-bids 1)) null)
                  (if (string-contains msg "Equilibrium") (set! equilibrium-bids (+ equilibrium-bids 1)) null)
                  (if (string-contains msg "SmartTrader") (set! smart-bids (+ smart-bids 1)) null)
                  (if (string-contains msg "WhaleTracker") (set! whale-bids (+ whale-bids 1)) null)
                  (if (and (string-contains msg "OVSM-Agent")
                           (not (string-contains msg "SmartTrader"))
                           (not (string-contains msg "Aggressor")))
                      (set! agent-bids (+ agent-bids 1)) null))
                null)

            ;; Count WINS (ACCEPTs mentioning agent)
            (if (string-contains msg-upper "ACCEPT")
                (do
                  (if (string-contains msg "Aggressor") (set! aggressor-wins (+ aggressor-wins 1)) null)
                  (if (string-contains msg "Premium") (set! premium-wins (+ premium-wins 1)) null)
                  (if (string-contains msg "Competitor") (set! competitor-wins (+ competitor-wins 1)) null)
                  (if (string-contains msg "Equilibrium") (set! equilibrium-wins (+ equilibrium-wins 1)) null)
                  (if (string-contains msg "SmartTrader") (set! smart-wins (+ smart-wins 1)) null)
                  (if (string-contains msg "WhaleTracker") (set! whale-wins (+ whale-wins 1)) null))
                null)

            ;; Count DELIVERS per agent
            (if (string-contains msg-upper "DELIVER")
                (do
                  (set! total-delivers (+ total-delivers 1))
                  (if (string-contains msg "Aggressor") (set! aggressor-delivers (+ aggressor-delivers 1)) null)
                  (if (string-contains msg "Premium") (set! premium-delivers (+ premium-delivers 1)) null)
                  (if (string-contains msg "Competitor") (set! competitor-delivers (+ competitor-delivers 1)) null)
                  (if (string-contains msg "Equilibrium") (set! equilibrium-delivers (+ equilibrium-delivers 1)) null)
                  (if (string-contains msg "SmartTrader") (set! smart-delivers (+ smart-delivers 1)) null)
                  (if (string-contains msg "WhaleTracker") (set! whale-delivers (+ whale-delivers 1)) null)
                  (if (string-contains msg "OVSM-Agent") (set! agent-delivers (+ agent-delivers 1)) null))
                null)))))

  ;; Calculate win rates
  (define calc-rate (lambda (wins bids)
    (if (> bids 0) (* (/ wins bids) 100.0) 0.0)))

  (define aggressor-rate (if (> aggressor-bids 0) (* (/ aggressor-wins aggressor-bids) 100.0) 0))
  (define premium-rate (if (> premium-bids 0) (* (/ premium-wins premium-bids) 100.0) 0))
  (define competitor-rate (if (> competitor-bids 0) (* (/ competitor-wins competitor-bids) 100.0) 0))
  (define equilibrium-rate (if (> equilibrium-bids 0) (* (/ equilibrium-wins equilibrium-bids) 100.0) 0))
  (define smart-rate (if (> smart-bids 0) (* (/ smart-wins smart-bids) 100.0) 0))
  (define whale-rate (if (> whale-bids 0) (* (/ whale-wins whale-bids) 100.0) 0))

  ;; Estimated revenue (wins * typical price)
  (define aggressor-revenue (* aggressor-wins 0.015))
  (define premium-revenue (* premium-wins 0.08))
  (define competitor-revenue (* competitor-wins 0.04))
  (define equilibrium-revenue (* equilibrium-wins 0.035))
  (define smart-revenue (* smart-wins 0.05))
  (define whale-revenue (* whale-wins 0.05))

  ;; Print results
  (log :message "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
  (log :message "â”‚                    MARKET OVERVIEW                              â”‚")
  (log :message "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
  (log :message (concatenate "â”‚  Total Posts: " (str total-posts)))
  (log :message (concatenate "â”‚  Requests: " (str total-requests) " | Bids: " (str total-bids) " | Accepts: " (str total-accepts) " | Delivers: " (str total-delivers)))
  (log :message "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
  (log :message "")

  (log :message "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
  (log :message "â”‚                 AGENT PERFORMANCE LEADERBOARD                   â”‚")
  (log :message "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
  (log :message "â”‚ Agent             â”‚ Bids  â”‚ Wins â”‚ Win Rate â”‚ Revenue  â”‚ Deliv  â”‚")
  (log :message "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤")

  (log :message (concatenate "â”‚ ğŸ”¥ Aggressor      â”‚ " (str aggressor-bids) "    â”‚ " (str aggressor-wins) "   â”‚ " (str aggressor-rate) "%  â”‚ " (str aggressor-revenue) " SOL â”‚ " (str aggressor-delivers) "     â”‚"))
  (log :message (concatenate "â”‚ ğŸ’ Premium        â”‚ " (str premium-bids) "    â”‚ " (str premium-wins) "   â”‚ " (str premium-rate) "%  â”‚ " (str premium-revenue) " SOL â”‚ " (str premium-delivers) "     â”‚"))
  (log :message (concatenate "â”‚ ğŸ“Š Competitor     â”‚ " (str competitor-bids) "    â”‚ " (str competitor-wins) "   â”‚ " (str competitor-rate) "%  â”‚ " (str competitor-revenue) " SOL â”‚ " (str competitor-delivers) "     â”‚"))
  (log :message (concatenate "â”‚ âš–ï¸  Equilibrium    â”‚ " (str equilibrium-bids) "    â”‚ " (str equilibrium-wins) "   â”‚ " (str equilibrium-rate) "%  â”‚ " (str equilibrium-revenue) " SOL â”‚ " (str equilibrium-delivers) "     â”‚"))
  (log :message (concatenate "â”‚ ğŸ“ˆ SmartTrader    â”‚ " (str smart-bids) "    â”‚ " (str smart-wins) "   â”‚ " (str smart-rate) "%  â”‚ " (str smart-revenue) " SOL â”‚ " (str smart-delivers) "     â”‚"))
  (log :message (concatenate "â”‚ ğŸ‹ WhaleTracker   â”‚ " (str whale-bids) "    â”‚ " (str whale-wins) "   â”‚ " (str whale-rate) "%  â”‚ " (str whale-revenue) " SOL â”‚ " (str whale-delivers) "     â”‚"))

  (log :message "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
  (log :message "")

  ;; Strategy analysis
  (log :message "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
  (log :message "â”‚                    STRATEGY ANALYSIS                            â”‚")
  (log :message "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")

  ;; Determine best performer by different metrics
  (define max-bids (if (> aggressor-bids equilibrium-bids) aggressor-bids equilibrium-bids))
  (define volume-leader (if (> aggressor-bids equilibrium-bids) "Aggressor" "Equilibrium"))

  (define max-revenue aggressor-revenue)
  (define revenue-leader "Aggressor")
  (if (> premium-revenue max-revenue) (do (set! max-revenue premium-revenue) (set! revenue-leader "Premium")) null)
  (if (> equilibrium-revenue max-revenue) (do (set! max-revenue equilibrium-revenue) (set! revenue-leader "Equilibrium")) null)
  (if (> smart-revenue max-revenue) (do (set! max-revenue smart-revenue) (set! revenue-leader "SmartTrader")) null)

  (log :message (concatenate "â”‚  ğŸ“ˆ Volume Leader:    " volume-leader " (" (str max-bids) " bids)"))
  (log :message (concatenate "â”‚  ğŸ’° Revenue Leader:   " revenue-leader " (" (str max-revenue) " SOL estimated)"))
  (log :message (concatenate "â”‚  ğŸ† Reputation Leader: WhaleTracker (" (str whale-delivers) " verified deliveries)"))
  (log :message "â”‚")
  (log :message "â”‚  Strategy Effectiveness:")
  (log :message "â”‚  â€¢ Race-to-bottom (Aggressor): High volume, low margin")
  (log :message "â”‚  â€¢ Premium positioning: Low volume, high margin per win")
  (log :message "â”‚  â€¢ Market following (Equilibrium): Adaptive, sustainable")
  (log :message "â”‚  â€¢ Budget-relative (Smart): Optimizes per-request")
  (log :message "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
  (log :message "")

  {:market {:posts total-posts :requests total-requests :bids total-bids :accepts total-accepts :delivers total-delivers}
   :agents {:aggressor {:bids aggressor-bids :wins aggressor-wins :delivers aggressor-delivers :revenue aggressor-revenue}
            :premium {:bids premium-bids :wins premium-wins :delivers premium-delivers :revenue premium-revenue}
            :competitor {:bids competitor-bids :wins competitor-wins :delivers competitor-delivers :revenue competitor-revenue}
            :equilibrium {:bids equilibrium-bids :wins equilibrium-wins :delivers equilibrium-delivers :revenue equilibrium-revenue}
            :smart {:bids smart-bids :wins smart-wins :delivers smart-delivers :revenue smart-revenue}
            :whale {:bids whale-bids :wins whale-wins :delivers whale-delivers :revenue whale-revenue}}
   :leaders {:volume volume-leader :revenue revenue-leader}})
