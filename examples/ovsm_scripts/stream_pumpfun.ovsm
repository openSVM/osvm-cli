;;; Stream Pump.fun Events - PRODUCTION FORENSICS TOOL v5
;;;
;;; TRULY EVENT-DRIVEN - No polling!
;;; - WebSocket with stream-wait (blocks until event arrives)
;;; - Instant event processing (<1ms latency)
;;; - TokenTransfer events for accurate data
;;; - Full addresses (no truncation)
;;; - Real token amounts and mints
;;; - Clean single-line output format
;;;
;;; Usage:
;;;   1. Start: osvm stream --programs pumpfun --port 8080
;;;   2. Run: osvm ovsm run stream_pumpfun.ovsm

(define stream-id (stream-connect "ws://localhost:8080/ws" :programs ["pumpfun"]))

(println "")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println "  OSVM PUMP.FUN FORENSICS MONITOR V5")
(println "  âš¡ Event-Driven WebSocket (No Polling!)")
(println "  ğŸ“Š TokenTransfer Events for Accurate Data")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println "")

;; Initialize counters
(define buy-count 0)
(define sell-count 0)
(define graduation-count 0)
(define transfer-count 0)

;; Main event loop (60 seconds) - EVENT-DRIVEN, NO POLLING!
(define start-time (now))
(define duration 60)
(define event-count 0)

(while (< (- (now) start-time) duration)
  ;; stream-wait BLOCKS until next event (truly event-driven!)
  (define event (stream-wait stream-id :timeout 1))

  (if (not (null? event))
      (do
        (set! event-count (+ event-count 1))
        (define event-type (get event "type"))

    ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ;; PROCESS TOKEN TRANSFER EVENTS (BEST SOURCE OF DATA)
    ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    (if (= event-type "token_transfer")
        (do
          (set! transfer-count (+ transfer-count 1))
          (define signature (get event "signature"))
          (define from-wallet (get event "from"))
          (define to-wallet (get event "to"))
          (define token-mint (get event "token"))
          (define amount (get event "amount"))
          (define decimals (get event "decimals"))

          ;; Check if this is a Pump.fun token (ends with "pump")
          (define is-pumpfun-token false)
          (if (> (length token-mint) 4)
              (do
                (define mint-len (length token-mint))
                (define last-4 (substring token-mint (- mint-len 4) mint-len))
                (if (= last-4 "pump")
                    (set! is-pumpfun-token true)
                    null))
              null)

          ;; Only display Pump.fun token transfers
          (if is-pumpfun-token
              (do
                (println "")
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                (println (str "ğŸ’¸ TOKEN TRANSFER #" transfer-count " | Time: " (now)))
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                (println (str "Signature:    " signature))
                (println (str "From:         " from-wallet))
                (println (str "To:           " to-wallet))
                (println (str "Token Mint:   " token-mint))
                (println (str "Amount:       " amount " (decimals: " decimals ")"))
                (println (str "osvm.ai:      https://osvm.ai/tx/" signature))
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"))
              null))
        null)

    ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ;; PROCESS LOG MESSAGES (FOR BUY/SELL/GRADUATION DETECTION)
    ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    (if (= event-type "log_message")
        (do
          (define logs (get event "logs"))
          (define signature (get event "signature"))
          (define slot (get event "slot"))
          (define logs-text (str logs))

          ;; Detect transaction type from logs
          (if (string-contains logs-text "Instruction: Buy")
              (set! buy-count (+ buy-count 1))
              null)

          (if (string-contains logs-text "Instruction: Sell")
              (set! sell-count (+ sell-count 1))
              null)

          (if (or (string-contains logs-text "raydium")
                  (string-contains logs-text "Instruction: Graduate"))
              (do
                (set! graduation-count (+ graduation-count 1))
                (println "")
                (println "ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“")
                (println (str "ğŸ“ TOKEN GRADUATION #" graduation-count " - MIGRATING TO RAYDIUM ğŸš€"))
                (println "ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“")
                (println (str "Signature: " signature))
                (println (str "Slot:      " slot))
                (println (str "osvm.ai:   https://osvm.ai/tx/" signature))
                (println "ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“"))
              null))
        null)

    ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ;; PROCESS TRANSACTION EVENTS (FOR WALLET/PROGRAM INFO)
    ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    (if (= event-type "transaction")
        (do
          ;; Future enhancement: Extract signer, program_ids, fees
          null)
        null))
      null))  ;; Close if (not (null? event))

;; Summary
(println "")
(println "")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println "  FORENSICS SUMMARY")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println (str "Duration:         " duration " seconds"))
(println (str "Events Processed: " event-count " (event-driven, no polling!)"))
(println (str "Buy Txs:          " buy-count))
(println (str "Sell Txs:         " sell-count))
(println (str "Token Transfers:  " transfer-count))
(println (str "Graduations:      " graduation-count))
(println (str "Total Events:     " (+ buy-count sell-count graduation-count transfer-count)))
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

(stream-close stream-id)
(println "")
(println "âœ… Stream closed")
