;;; Stream Pump.fun Events - PRODUCTION FORENSICS TOOL v2
;;;
;;; Clean, professional output for blockchain investigation
;;; - Full addresses (no truncation)
;;; - Token mints and amounts
;;; - Clean single-line output format
;;;
;;; Usage:
;;;   1. Start: osvm stream --programs pumpfun --port 8080
;;;   2. Run: osvm ovsm run stream_pumpfun_v2.ovsm

(define stream-id (stream-connect "http://localhost:8080" :programs ["pumpfun"]))

(println "")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println "  OSVM PUMP.FUN FORENSICS MONITOR")
(println "  Connected to event stream - monitoring transactions...")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println "")

;; Initialize counters
(define buy-count 0)
(define sell-count 0)
(define graduation-count 0)

;; Main event loop (60 seconds)
(define start-time (now))
(define duration 60)

(while (< (- (now) start-time) duration)
  (define events (stream-poll stream-id :limit 50))

  (for (event events)
    (define event-type (get event "type"))

    (if (= event-type "log_message")
        (do
          (define logs (get event "logs"))
          (define signature (get event "signature"))
          (define slot (get event "slot"))
          (define logs-text (str logs))

          ;; Extract wallet from first invoke [1]
          (define wallet "Unknown")
          (for (line logs)
            (if (and (string-contains line "invoke [1]")
                     (not (string-contains line "ComputeBudget"))
                     (not (string-contains line "11111111")))
                (do
                  (define parts (split line " "))
                  (if (>= (length parts) 2)
                      (set! wallet (get parts 1))
                      null))
                null))

          ;; Extract program ID
          (define program-id "Unknown")
          (define program-name "Unknown")
          (for (line logs)
            (if (and (string-contains line "invoke [1]")
                     (not (string-contains line "ComputeBudget"))
                     (not (string-contains line "11111111")))
                (do
                  (define parts (split line " "))
                  (if (>= (length parts) 2)
                      (do
                        (set! program-id (get parts 1))
                        (if (string-contains program-id "6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P")
                            (set! program-name "Pump.fun Core") null)
                        (if (string-contains program-id "MAyhSmzXzV1pTf7LsNkrNwkWKTo4ougAJ1PPg47MD4e")
                            (set! program-name "Pump.fun Wrapper") null)
                        (if (string-contains program-id "BLUR9cL8HqZzu5bSaC7VRX25RCG93Hv3T6NPyKxQhWUT")
                            (set! program-name "BLUR Bot") null)
                        (if (string-contains program-id "GMgnVFR8Jb39LoXsEVzb3DvBy3ywCmdmJquHUy1Lrkqb")
                            (set! program-name "GMgn Bot") null))
                      null))
                null))

          ;; Extract SOL amount
          (define sol-amount "Unknown")
          (for (line logs)
            (if (string-contains line "sol_received:")
                (do
                  (define parts (split line ":"))
                  (if (>= (length parts) 3)
                      (do
                        (define amount-str (get parts 2))
                        (define amount-parts (split amount-str ","))
                        (if (>= (length amount-parts) 1)
                            (set! sol-amount (get amount-parts 0))
                            null))
                      null))
                null))

          ;; Extract token program
          (define token-program "Unknown")
          (for (line logs)
            (if (string-contains line "TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb")
                (set! token-program "Token2022") null)
            (if (string-contains line "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA")
                (set! token-program "SPL Token") null))

          ;; Extract token mint from logs
          ;; Look for base58 addresses in lines near TransferChecked
          (define token-mint "Unknown")
          (define token-amount "Unknown")
          (define found-transfer false)

          ;; Strategy: Find TransferChecked, then look for addresses in nearby lines
          (for (line logs)
            (if (string-contains line "TransferChecked")
                (set! found-transfer true)
                null))

          ;; If we found TransferChecked, look for potential token addresses
          ;; Token addresses appear in lines like:
          ;; "Program TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb invoke [3]"
          ;; Or in account references
          (if found-transfer
              (do
                ;; Look for invoke [2] or [3] which are often token program calls
                (for (line logs)
                  (if (and (or (string-contains line "invoke [2]")
                               (string-contains line "invoke [3]"))
                           (not (string-contains line "TokenkegQ"))
                           (not (string-contains line "TokenzQdBN"))
                           (not (string-contains line "11111111"))
                           (not (string-contains line "ComputeBudget")))
                      (do
                        ;; Extract potential mint address
                        (define parts (split line " "))
                        (if (>= (length parts) 2)
                            (do
                              (define potential-mint (get parts 1))
                              ;; Check if it looks like a base58 address (32+ chars)
                              (if (> (length potential-mint) 32)
                                  (set! token-mint potential-mint)
                                  null))
                            null))
                      null)))
              null)

          ;; Try to find token_transfer event as fallback
          (for (evt events)
            (if (= (get evt "type") "token_transfer")
                (do
                  (if (= (get evt "signature") signature)
                      (do
                        (set! token-mint (get evt "token"))
                        (set! token-amount (str (get evt "amount") " (decimals: " (get evt "decimals") ")")))
                      null))
                null))

          ;; Display BUY transactions
          (if (string-contains logs-text "Instruction: Buy")
              (do
                (set! buy-count (+ buy-count 1))
                (println "")
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                (println (str "ğŸ“ˆ BUY #" buy-count " | Slot: " slot " | Time: " (now)))
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                (println (str "Signature:    " signature))
                (println (str "Wallet:       " wallet))
                (println (str "Program:      " program-name " (" program-id ")"))
                (println (str "Token Std:    " token-program))
                (println (str "Token Mint:   " token-mint))
                (println (str "Token Amount: " token-amount))
                (println (str "SOL Spent:    " sol-amount " lamports"))
                (println (str "osvm.ai:      https://osvm.ai/tx/" signature))
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"))
              null)

          ;; Display SELL transactions
          (if (string-contains logs-text "Instruction: Sell")
              (do
                (set! sell-count (+ sell-count 1))
                (println "")
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                (println (str "ğŸ“‰ SELL #" sell-count " | Slot: " slot " | Time: " (now)))
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                (println (str "Signature:    " signature))
                (println (str "Wallet:       " wallet))
                (println (str "Program:      " program-name " (" program-id ")"))
                (println (str "Token Std:    " token-program))
                (println (str "Token Mint:   " token-mint))
                (println (str "Token Amount: " token-amount))
                (println (str "SOL Received: " sol-amount " lamports"))
                (println (str "osvm.ai:      https://osvm.ai/tx/" signature))
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"))
              null)

          ;; Display graduations
          (if (or (string-contains logs-text "raydium")
                  (string-contains logs-text "Instruction: Graduate"))
              (do
                (set! graduation-count (+ graduation-count 1))
                (println "")
                (println "ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“")
                (println (str "ğŸ“ TOKEN GRADUATION #" graduation-count " - MIGRATING TO RAYDIUM ğŸš€"))
                (println "ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“")
                (println (str "Signature: " signature))
                (println (str "Token:     " token-mint))
                (println (str "osvm.ai:   https://osvm.ai/tx/" signature))
                (println "ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“"))
              null))
        null)))

;; Summary
(println "")
(println "")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println "  FORENSICS SUMMARY")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println (str "Duration:      " duration " seconds"))
(println (str "Buy Txs:       " buy-count))
(println (str "Sell Txs:      " sell-count))
(println (str "Graduations:   " graduation-count))
(println (str "Total Events:  " (+ buy-count sell-count graduation-count)))
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

(stream-close stream-id)
(println "")
(println "âœ… Stream closed")
