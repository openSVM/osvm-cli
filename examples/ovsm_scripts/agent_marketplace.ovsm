;;; ═══════════════════════════════════════════════════════════════════════════════
;;; AGENT MARKETPLACE - Reputation-Gated Service Listings
;;; Written in OVSM LISP - Compiles to Solana sBPF
;;; ═══════════════════════════════════════════════════════════════════════════════
;;;
;;; Purpose:
;;; - Marketplace where AI agents list services they can perform
;;; - Only agents meeting reputation thresholds can list
;;; - Collateral requirements reduced based on reputation score
;;; - Demonstrates CPI to reputation_attestation program
;;;
;;; Key Innovation:
;;; - Before CreateListing, we CPI to attestation.VerifyThreshold
;;; - If agent fails threshold, listing is rejected
;;; - High-reputation agents get reduced listing fees
;;;
;;; Accounts Layout:
;;;   0: Listing PDA account
;;;   1: Agent wallet (signer)
;;;   2: Agent's Reputation NFT account
;;;   3: Attestation output buffer (temp account)
;;;   4: Attestation program ID
;;;   5: Fee vault (marketplace treasury)
;;;
;;; Instructions:
;;;   0 = CreateListing (requires reputation check)
;;;   1 = UpdateListing (owner only)
;;;   2 = AcceptJob (client hires agent)
;;;   3 = CompleteListing (close and refund deposit)
;;;   4 = QueryListingFee (returns fee based on reputation)
;;;
;;; Listing Account Data Layout (128 bytes):
;;;   offset 0:   u8 status (0=Empty, 1=Active, 2=Hired, 3=Completed, 4=Cancelled)
;;;   offset 1:   u8 category (service type)
;;;   offset 8:   u64 price (lamports)
;;;   offset 16:  u64 deposit (reduced by reputation)
;;;   offset 24:  u64 created_at
;;;   offset 32:  u64 expires_at
;;;   offset 40:  32 bytes agent_pubkey
;;;   offset 72:  32 bytes client_pubkey (if hired)
;;;   offset 104: 24 bytes metadata_hash
;;; ═══════════════════════════════════════════════════════════════════════════════

(do
  (sol_log_ "=== AGENT MARKETPLACE ===")

  (define instr_ptr (instruction-data-ptr))
  (define discriminator (mem-load1 instr_ptr 0))
  (define listing_ptr (account-data-ptr 0))
  (define status (mem-load1 listing_ptr 0))

  ;; Constants
  (define STATUS_EMPTY 0)
  (define STATUS_ACTIVE 1)
  (define STATUS_HIRED 2)
  (define STATUS_COMPLETED 3)
  (define STATUS_CANCELLED 4)

  (define BASE_FEE 10000000)        ;; 0.01 SOL base listing fee
  (define BASE_DEPOSIT 100000000)   ;; 0.1 SOL base deposit

  ;; Minimum reputation requirements for marketplace
  (define MIN_TASKS 5)              ;; Must have completed 5 tasks
  (define MIN_RATING_X10 30)        ;; Must have 3.0+ rating
  (define MAX_DECAY 50)             ;; Must have <50% decay

  ;; ═══════════════════════════════════════════════════════════════════════════
  ;; INSTRUCTION 0: CREATE LISTING
  ;; Creates a new service listing after verifying agent reputation
  ;; ═══════════════════════════════════════════════════════════════════════════
  (if (= discriminator 0)
    (do
      (sol_log_ ">>> CREATE LISTING <<<")

      ;; Verify listing slot is empty
      (if (!= status STATUS_EMPTY)
        (do (sol_log_ "ERROR: Slot not empty") 1)
        (do
          ;; Verify agent is signer
          (if (= (account-is-signer 1) 0)
            (do (sol_log_ "ERROR: Agent must sign") 2)
            (do
              ;; Read agent's reputation NFT to check initialization
              (define nft_ptr (account-data-ptr 2))
              (define nft_init (mem-load1 nft_ptr 0))

              (if (!= nft_init 1)
                (do
                  (sol_log_ "ERROR: No reputation NFT")
                  3)
                (do
                  ;; Manually check reputation thresholds
                  ;; (In production, this would CPI to attestation program)
                  (define tasks_ok (mem-load nft_ptr 8))
                  (define tasks_fail (mem-load nft_ptr 16))
                  (define net_tasks (- tasks_ok (* tasks_fail 2)))
                  (define total_r (mem-load nft_ptr 40))
                  (define sum (mem-load nft_ptr 48))
                  (define rating_x10 (if (> total_r 0)
                                       (/ (* sum 10) total_r)
                                       0))
                  (define last_active (mem-load nft_ptr 80))
                  (define now (get-clock-timestamp))
                  (define days_inactive (/ (- now last_active) 86400))
                  (define decay_factor
                    (if (>= days_inactive 30)
                      100
                      (/ (* days_inactive 100) 30)))

                  ;; Check thresholds
                  (define threshold_pass
                    (if (< net_tasks MIN_TASKS)
                      0
                      (if (< rating_x10 MIN_RATING_X10)
                        0
                        (if (> decay_factor MAX_DECAY)
                          0
                          1))))

                  (if (= threshold_pass 0)
                    (do
                      (sol_log_ "ERROR: Reputation too low")
                      (sol_log_ "Net tasks:")
                      (sol_log_64_ net_tasks)
                      (sol_log_ "Rating x10:")
                      (sol_log_64_ rating_x10)
                      (sol_log_ "Decay %:")
                      (sol_log_64_ decay_factor)
                      4)
                    (do
                      ;; Calculate fee discount based on reputation
                      ;; trust_score approximation
                      (define total_tasks (+ tasks_ok tasks_fail))
                      (define task_score
                        (if (= total_tasks 0)
                          0
                          (/ (* net_tasks 50) total_tasks)))
                      (define rating_score (/ (* rating_x10 30) 50))
                      (define raw_trust (+ task_score rating_score))
                      (define trust_score
                        (if (>= decay_factor 100)
                          0
                          (/ (* raw_trust (- 100 decay_factor)) 100)))

                      ;; Discount = trust_score * 90 / 100
                      (define discount (/ (* trust_score 90) 100))

                      ;; Calculate actual fee and deposit
                      (define actual_fee (/ (* BASE_FEE (- 100 discount)) 100))
                      (define actual_deposit (/ (* BASE_DEPOSIT (- 100 discount)) 100))

                      ;; Read listing parameters from instruction
                      (define price (mem-load instr_ptr 1))
                      (define category (mem-load1 instr_ptr 9))
                      (define duration (mem-load instr_ptr 10))

                      ;; Initialize listing
                      (mem-store listing_ptr 0 STATUS_ACTIVE)
                      (mem-store listing_ptr 1 category)
                      (mem-store listing_ptr 8 price)
                      (mem-store listing_ptr 16 actual_deposit)
                      (mem-store listing_ptr 24 now)
                      (mem-store listing_ptr 32 (+ now duration))

                      ;; Store agent pubkey
                      (define agent_pk (account-pubkey 1))
                      (mem-store listing_ptr 40 (mem-load agent_pk 0))
                      (mem-store listing_ptr 48 (mem-load agent_pk 8))
                      (mem-store listing_ptr 56 (mem-load agent_pk 16))
                      (mem-store listing_ptr 64 (mem-load agent_pk 24))

                      (sol_log_ "Listing created!")
                      (sol_log_ "Trust score:")
                      (sol_log_64_ trust_score)
                      (sol_log_ "Discount %:")
                      (sol_log_64_ discount)
                      (sol_log_ "Listing fee:")
                      (sol_log_64_ actual_fee)
                      (sol_log_ "Required deposit:")
                      (sol_log_64_ actual_deposit)
                      0)))))))))
    null)

  ;; ═══════════════════════════════════════════════════════════════════════════
  ;; INSTRUCTION 1: UPDATE LISTING
  ;; Owner can update price and extend expiry
  ;; ═══════════════════════════════════════════════════════════════════════════
  (if (= discriminator 1)
    (do
      (sol_log_ ">>> UPDATE LISTING <<<")
      (if (!= status STATUS_ACTIVE)
        (do (sol_log_ "ERROR: Not active") 10)
        (do
          (if (= (account-is-signer 1) 0)
            (do (sol_log_ "ERROR: Owner must sign") 11)
            (do
              ;; Verify caller is listing owner
              (define stored_pk_0 (mem-load listing_ptr 40))
              (define agent_pk (account-pubkey 1))
              (define caller_pk_0 (mem-load agent_pk 0))

              (if (!= stored_pk_0 caller_pk_0)
                (do (sol_log_ "ERROR: Not owner") 12)
                (do
                  (define new_price (mem-load instr_ptr 1))
                  (define extend_duration (mem-load instr_ptr 9))

                  (if (> new_price 0)
                    (do (mem-store listing_ptr 8 new_price) 0)
                    0)

                  (if (> extend_duration 0)
                    (do
                      (define current_expiry (mem-load listing_ptr 32))
                      (mem-store listing_ptr 32 (+ current_expiry extend_duration))
                      0)
                    0)

                  (sol_log_ "Listing updated")
                  0)))))))
    null)

  ;; ═══════════════════════════════════════════════════════════════════════════
  ;; INSTRUCTION 2: ACCEPT JOB
  ;; Client hires the agent for this listing
  ;; ═══════════════════════════════════════════════════════════════════════════
  (if (= discriminator 2)
    (do
      (sol_log_ ">>> ACCEPT JOB <<<")
      (if (!= status STATUS_ACTIVE)
        (do (sol_log_ "ERROR: Not available") 20)
        (do
          ;; Check listing hasn't expired
          (define now (get-clock-timestamp))
          (define expires (mem-load listing_ptr 32))
          (if (> now expires)
            (do (sol_log_ "ERROR: Listing expired") 21)
            (do
              (if (= (account-is-signer 1) 0)
                (do (sol_log_ "ERROR: Client must sign") 22)
                (do
                  ;; Transfer price to escrow (simplified - just log)
                  (define price (mem-load listing_ptr 8))
                  (sol_log_ "Transferring to escrow:")
                  (sol_log_64_ price)

                  ;; Update status
                  (mem-store listing_ptr 0 STATUS_HIRED)

                  ;; Store client pubkey at offset 72
                  (define client_pk (account-pubkey 1))
                  (mem-store listing_ptr 72 (mem-load client_pk 0))
                  (mem-store listing_ptr 80 (mem-load client_pk 8))
                  (mem-store listing_ptr 88 (mem-load client_pk 16))
                  (mem-store listing_ptr 96 (mem-load client_pk 24))

                  (sol_log_ "Job accepted!")
                  0)))))))
    null)

  ;; ═══════════════════════════════════════════════════════════════════════════
  ;; INSTRUCTION 3: COMPLETE LISTING
  ;; Close listing and refund deposit to agent
  ;; ═══════════════════════════════════════════════════════════════════════════
  (if (= discriminator 3)
    (do
      (sol_log_ ">>> COMPLETE LISTING <<<")
      (if (= status STATUS_EMPTY)
        (do (sol_log_ "ERROR: No listing") 30)
        (do
          (if (= (account-is-signer 1) 0)
            (do (sol_log_ "ERROR: Must sign") 31)
            (do
              ;; Refund deposit to agent
              (define deposit (mem-load listing_ptr 16))
              (sol_log_ "Refunding deposit:")
              (sol_log_64_ deposit)

              ;; Mark completed
              (mem-store listing_ptr 0 STATUS_COMPLETED)

              (sol_log_ "Listing completed!")
              0)))))
    null)

  ;; ═══════════════════════════════════════════════════════════════════════════
  ;; INSTRUCTION 4: QUERY LISTING FEE
  ;; Returns the fee an agent would pay based on their reputation
  ;; ═══════════════════════════════════════════════════════════════════════════
  (if (= discriminator 4)
    (do
      (sol_log_ ">>> QUERY FEE <<<")
      (define nft_ptr (account-data-ptr 2))
      (define nft_init (mem-load1 nft_ptr 0))

      (if (!= nft_init 1)
        (do
          ;; No reputation = full price
          (sol_log_ "No reputation: Full fee")
          (sol_log_64_ BASE_FEE)
          (sol_log_64_ BASE_DEPOSIT)
          BASE_FEE)
        (do
          ;; Calculate trust score and discount
          (define tasks_ok (mem-load nft_ptr 8))
          (define tasks_fail (mem-load nft_ptr 16))
          (define net_tasks (- tasks_ok (* tasks_fail 2)))
          (define total_r (mem-load nft_ptr 40))
          (define sum (mem-load nft_ptr 48))
          (define rating_x10 (if (> total_r 0)
                               (/ (* sum 10) total_r)
                               0))
          (define last_active (mem-load nft_ptr 80))
          (define now (get-clock-timestamp))
          (define days_inactive (/ (- now last_active) 86400))

          (define total_tasks (+ tasks_ok tasks_fail))
          (define task_score
            (if (= total_tasks 0)
              0
              (if (< net_tasks 0)
                0
                (/ (* net_tasks 50) total_tasks))))
          (define rating_score (/ (* rating_x10 30) 50))
          (define raw_trust (+ task_score rating_score))
          (define trust_score
            (if (>= days_inactive 30)
              0
              (/ (* raw_trust (- 30 days_inactive)) 30)))

          (define discount (/ (* trust_score 90) 100))
          (define actual_fee (/ (* BASE_FEE (- 100 discount)) 100))
          (define actual_deposit (/ (* BASE_DEPOSIT (- 100 discount)) 100))

          (sol_log_ "Trust score:")
          (sol_log_64_ trust_score)
          (sol_log_ "Discount %:")
          (sol_log_64_ discount)
          (sol_log_ "Listing fee:")
          (sol_log_64_ actual_fee)
          (sol_log_ "Required deposit:")
          (sol_log_64_ actual_deposit)
          actual_fee)))
    null)

  ;; Unknown instruction
  (if (> discriminator 4)
    (do (sol_log_ "ERROR: Unknown") 99)
    null)

  (sol_log_ "=== MARKETPLACE COMPLETE ===")
  0)
