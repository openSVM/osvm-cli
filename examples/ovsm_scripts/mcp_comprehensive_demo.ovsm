;; Comprehensive OSVM-MCP Tool Demonstration
;; Shows usage of all major tool categories
;;
;; Run with: osvm ovsm run examples/ovsm_scripts/mcp_comprehensive_demo.ovsm --debug
;; Requires: osvm-mcp server configured

(log :message "=== OSVM-MCP COMPREHENSIVE DEMO ===\n")

;; Test wallet (Solana Foundation)
(define test_wallet "GBBbhHigLDyfxV71A24vGM2JLFukdChaNDTXGED1mF5r")

;; ============================================
;; 1. ACCOUNT TOOLS
;; ============================================
(log :message "\nğŸ“Š 1. ACCOUNT TOOLS")
(log :message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

;; 1.1 Account Stats
(log :message "\n1.1 Getting account statistics...")
(define stats (get_account_stats {:address test_wallet}))
(log :message "Total transactions:" :value (. stats totalTransactions))
(log :message "Token transfers:" :value (. stats tokenTransfers))

;; 1.2 Account Portfolio
(log :message "\n1.2 Getting account portfolio...")
(define portfolio (get_account_portfolio {:address test_wallet}))
(define sol_balance (. (. portfolio native) balance))
(define sol_price (. (. portfolio native) price))
(log :message "SOL Balance:" :value sol_balance)
(log :message "SOL Price:" :value sol_price)
(log :message "Total Portfolio Value:" :value (. portfolio totalValue))

;; 1.3 Account Type
(log :message "\n1.3 Checking account type...")
(define account_type (check_account_type {:address test_wallet}))
(log :message "Account type:" :value (. account_type type))

;; ============================================
;; 2. TRANSACTION TOOLS
;; ============================================
(log :message "\n\nğŸ’¸ 2. TRANSACTION TOOLS")
(log :message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

;; 2.1 Get Recent Transactions
(log :message "\n2.1 Fetching recent transactions...")
(define txs (get_account_transactions {:address test_wallet :limit 5}))
(log :message "Found transactions:" :value (length txs))

(if (> (length txs) 0)
    (do
      (define first_tx (first txs))
      (define first_sig (. first_tx signature))
      (log :message "Most recent signature:" :value first_sig)

      ;; 2.2 Get Transaction Details
      (log :message "\n2.2 Getting transaction details...")
      (define tx_detail (get_transaction {:signature first_sig}))
      (log :message "Slot:" :value (. tx_detail slot))
      (log :message "Block time:" :value (. tx_detail blockTime))
      (log :message "Fee (lamports):" :value (. tx_detail fee))

      ;; 2.3 Transaction Explanation
      (log :message "\n2.3 Getting AI explanation...")
      (define explanation (explain_transaction {:signature first_sig}))
      (log :message "Explanation:" :value (. explanation text)))
    (log :message "No transactions found"))

;; ============================================
;; 3. BLOCK TOOLS
;; ============================================
(log :message "\n\nâ›“ï¸  3. BLOCK TOOLS")
(log :message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

;; 3.1 Get Current Slot
(log :message "\n3.1 Getting current slot...")
(define current_slot (getSlot))
(log :message "Current slot:" :value current_slot)

;; 3.2 Get Block
(log :message "\n3.2 Getting block data...")
(define block (get_block {:slot current_slot}))
(log :message "Block time:" :value (. block blockTime))
(log :message "Parent slot:" :value (. block parentSlot))
(log :message "Transactions in block:" :value (length (. block transactions)))

;; 3.3 Block Stats
(log :message "\n3.3 Getting network stats...")
(define block_stats (get_block_stats {}))
(log :message "Current TPS:" :value (. block_stats tps))
(log :message "Avg block time:" :value (. block_stats avgBlockTime))

;; ============================================
;; 4. DEFI ANALYTICS TOOLS
;; ============================================
(log :message "\n\nğŸ“ˆ 4. DEFI ANALYTICS TOOLS")
(log :message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

;; 4.1 DeFi Overview
(log :message "\n4.1 Getting DeFi ecosystem overview...")
(define defi (get_defi_overview {}))
(log :message "Total TVL:" :value (. defi totalTvl))
(log :message "24h Volume:" :value (. defi totalVolume24h))
(log :message "Active DEXes:" :value (. defi activeDexes))

(log :message "\nTop protocols:")
(define top_protocols (. defi topProtocols))
(for (protocol (take 3 top_protocols))
  (log :message "  -" :value (. protocol name))
  (log :message "   TVL:" :value (. protocol tvl))
  (log :message "   24h Volume:" :value (. protocol volume24h)))

;; 4.2 Validator Analytics
(log :message "\n4.2 Getting validator analytics...")
(define validators (get_validator_analytics {}))
(log :message "Total validators:" :value (. validators total))
(log :message "Active validators:" :value (. validators active))

;; ============================================
;; 5. TOKEN TOOLS
;; ============================================
(log :message "\n\nğŸª™ 5. TOKEN TOOLS")
(log :message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

;; 5.1 Get Token Info (USDC)
(log :message "\n5.1 Getting token info for USDC...")
(define usdc_mint "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v")
(define token_info (get_token_info {:mint usdc_mint}))
(log :message "Symbol:" :value (. token_info symbol))
(log :message "Name:" :value (. token_info name))
(log :message "Decimals:" :value (. token_info decimals))
(log :message "Supply:" :value (. token_info supply))

;; ============================================
;; 6. SEARCH TOOLS
;; ============================================
(log :message "\n\nğŸ” 6. SEARCH TOOLS")
(log :message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

;; 6.1 Universal Search
(log :message "\n6.1 Searching for 'pump' tokens...")
(define search_results (universal_search {:query "pump" :types ["token"]}))
(log :message "Found results:" :value (length search_results))

;; ============================================
;; 7. DIRECT RPC ACCESS
;; ============================================
(log :message "\n\nğŸ”Œ 7. DIRECT RPC ACCESS")
(log :message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

;; 7.1 Get Version via RPC
(log :message "\n7.1 Getting Solana version via RPC...")
(define version_result (solana_rpc_call {:method "getVersion"}))
(define version (. version_result result))
(log :message "Solana version:" :value (. version solana-core))
(log :message "Feature set:" :value (. version feature-set))

;; 7.2 Get Block Height via RPC
(log :message "\n7.2 Getting block height via RPC...")
(define height_result (solana_rpc_call {:method "getBlockHeight"}))
(define height (. height_result result))
(log :message "Block height:" :value height)

;; ============================================
;; 8. UTILITY TOOLS
;; ============================================
(log :message "\n\nğŸ› ï¸  8. UTILITY TOOLS")
(log :message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

;; 8.1 Get Program Registry
(log :message "\n8.1 Getting program registry...")
(define programs (get_program_registry {}))
(log :message "Registered programs:" :value (length programs))

(if (> (length programs) 0)
    (do
      (define first_program (first programs))
      (log :message "Example program:" :value (. first_program name))
      (log :message "Program ID:" :value (. first_program programId)))
    null)

;; ============================================
;; SUMMARY
;; ============================================
(log :message "\n\nâœ… DEMO COMPLETE!")
(log :message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
(log :message "Demonstrated 8 tool categories")
(log :message "All 75+ tools available via dynamic discovery")
(log :message "See MCP_TOOLS_REFERENCE.md for complete API documentation")

"Demo completed successfully! âœ¨"
