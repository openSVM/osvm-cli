;;; OVSM V6: Concurrent Event Processing with async-call
;;;
;;; This script demonstrates parallel processing of blockchain events
;;; using the thread pool for maximum throughput.

(println "")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println "  OSVM V6 - CONCURRENT EVENT PROCESSING")
(println "  ğŸš€ Multi-Core Parallel Processing with async-call")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println "")

;; Connect to Pump.fun WebSocket stream
(define stream-id (stream-connect "ws://localhost:8080/ws" :programs ["pumpfun"]))

(println "âœ… Connected to WebSocket stream")
(println (str "ğŸ”§ Thread pool initialized (" (getenv "NUM_CPUS" "8") " workers)"))
(println "ğŸ“¡ Starting concurrent event processing...")
(println "")

;; ==================================================================
;; DEFINE EVENT HANDLERS (These will run concurrently in thread pool)
;; ==================================================================

;; Handler for token transfers
(defun handle-transfer (event)
  (do
    (define token (get event "token"))
    (define amount (get event "amount"))
    (define from (get event "from"))
    (define to (get event "to"))

    ;; Check if it's a Pump.fun token (ends with "pump")
    (if (> (length token) 4)
        (do
          (define last-4 (substring token (- (length token) 4) (length token)))
          (if (= last-4 "pump")
              (do
                (println "")
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                (println (str "ğŸ’¸ TRANSFER: " amount " tokens"))
                (println (str "Token:  " token))
                (println (str "From:   " from))
                (println (str "To:     " to))
                (println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"))
              null))
        null)))

;; Handler for buy events
(defun handle-buy (event)
  (do
    (define sig (get event "signature"))
    (println "")
    (println "ğŸŸ¢ BUY EVENT DETECTED!")
    (println (str "Signature: " sig))
    (println (str "osvm.ai:   https://osvm.ai/tx/" sig))))

;; Handler for sell events
(defun handle-sell (event)
  (do
    (define sig (get event "signature"))
    (println "")
    (println "ğŸ”´ SELL EVENT DETECTED!")
    (println (str "Signature: " sig))
    (println (str "osvm.ai:   https://osvm.ai/tx/" sig))))

;; Handler for graduation events
(defun handle-graduation (event)
  (do
    (define sig (get event "signature"))
    (define slot (get event "slot"))
    (println "")
    (println "ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“")
    (println "ğŸ“ TOKEN GRADUATION - MIGRATING TO RAYDIUM ğŸš€")
    (println "ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“")
    (println (str "Signature: " sig))
    (println (str "Slot:      " slot))
    (println (str "osvm.ai:   https://osvm.ai/tx/" sig))
    (println "ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“ğŸ“")
    (println "")))

;; ==================================================================
;; MAIN EVENT LOOP - Dispatches events to thread pool
;; ==================================================================

(define start-time (now))
(define duration 60)
(define event-count 0)
(define async-count 0)

(println (str "â±ï¸  Processing for " duration " seconds with concurrent handlers..."))
(println "")

(while (< (- (now) start-time) duration)
  ;; stream-wait BLOCKS until next event arrives (<1ms latency)
  (define event (stream-wait stream-id :timeout 1))

  (if (not (null? event))
      (do
        (set! event-count (+ event-count 1))
        (define event-type (get event "type"))

        ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ;; V6 CONCURRENT DISPATCH - async-call returns immediately
        ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        (if (= event-type "token_transfer")
            (do
              (async-call handle-transfer event)  ;; Dispatches to thread pool
              (set! async-count (+ async-count 1)))
            null)

        (if (= event-type "log_message")
            (do
              (define logs (str (get event "logs")))

              (if (string-contains logs "Instruction: Buy")
                  (do
                    (async-call handle-buy event)  ;; Concurrent processing
                    (set! async-count (+ async-count 1)))
                  null)

              (if (string-contains logs "Instruction: Sell")
                  (do
                    (async-call handle-sell event)  ;; Concurrent processing
                    (set! async-count (+ async-count 1)))
                  null)

              (if (or (string-contains logs "raydium")
                      (string-contains logs "Instruction: Graduate"))
                  (do
                    (async-call handle-graduation event)  ;; Concurrent processing
                    (set! async-count (+ async-count 1)))
                  null))
            null))
      null))

;; Summary
(println "")
(println "")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println "  CONCURRENT PROCESSING SUMMARY")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
(println (str "Duration:         " duration " seconds"))
(println (str "Events Received:  " event-count " (event-driven, no polling!)"))
(println (str "Async Dispatches: " async-count " (processed concurrently)"))
(println (str "Throughput:       " (/ event-count duration) " events/sec"))
(println "")
(println "ğŸš€ V6 FEATURES:")
(println "   âœ… Event-driven WebSocket (<1ms latency)")
(println "   âœ… Concurrent processing (thread pool)")
(println "   âœ… Multi-core utilization")
(println "   âœ… Non-blocking event dispatch")
(println "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

(stream-close stream-id)
(println "")
(println "âœ… Stream closed")
(println "â³ Waiting for async tasks to complete...")
(sleep 1000)  ;; Give thread pool time to finish
(println "âœ… All done!")
