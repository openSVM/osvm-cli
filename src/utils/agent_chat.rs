//! Agent Chat UI using cursive-multiplex
//! 
//! This module provides an interactive chat interface that can use MCP servers as tools
//! to assist users with various tasks.

use cursive::{Cursive, CursiveExt};
use cursive::views::{Dialog, EditView, LinearLayout, TextView, ScrollView, Panel, Button};
use cursive::traits::*;
use cursive::direction::Orientation;
use cursive_multiplex::{Mux, Id};
use crate::services::mcp_service::{McpService, McpTool};
use anyhow::{Result, Context};
use serde_json::Value;
use std::sync::{Arc, Mutex};
use tokio::sync::mpsc;
use std::collections::HashMap;

/// Message types in the chat interface
#[derive(Clone, Debug)]
pub enum ChatMessage {
    User(String),
    Agent(String),
    System(String),
    ToolCall(String, String, Option<Value>), // tool_name, description, args
    ToolResult(String, Value), // tool_name, result
    Error(String),
}

/// Shared chat state
#[derive(Clone)]
pub struct ChatState {
    pub messages: Arc<Mutex<Vec<ChatMessage>>>,
    pub mcp_service: Arc<Mutex<McpService>>,
    pub available_tools: Arc<Mutex<HashMap<String, Vec<McpTool>>>>, // server_id -> tools
}

impl ChatState {
    pub fn new() -> Result<Self> {
        let mut mcp_service = McpService::new_with_debug(false);
        
        // Load existing MCP configurations
        if let Err(e) = mcp_service.load_config() {
            eprintln!("‚ö†Ô∏è  Warning: Failed to load MCP config: {}", e);
        }

        Ok(ChatState {
            messages: Arc::new(Mutex::new(Vec::new())),
            mcp_service: Arc::new(Mutex::new(mcp_service)),
            available_tools: Arc::new(Mutex::new(HashMap::new())),
        })
    }

    pub fn refresh_tools_sync(&self) -> Result<()> {
        // For now, just load available servers without making async calls
        // In a full implementation, this would use a background task to refresh tools
        let mcp_service = self.mcp_service.lock().unwrap();
        let servers = mcp_service.list_servers();
        let mut available_tools = self.available_tools.lock().unwrap();
        available_tools.clear();

        for (server_id, config) in servers {
            if config.enabled {
                // For the initial implementation, we'll just mark servers as available
                // without actually fetching their tools
                available_tools.insert(server_id.clone(), vec![]);
            }
        }

        Ok(())
    }

    pub fn add_message(&self, message: ChatMessage) {
        let mut messages = self.messages.lock().unwrap();
        messages.push(message);
    }

    pub fn get_messages(&self) -> Vec<ChatMessage> {
        let messages = self.messages.lock().unwrap();
        messages.clone()
    }
}

/// Main chat UI application
pub struct AgentChatUI {
    state: ChatState,
}

impl AgentChatUI {
    pub fn new() -> Result<Self> {
        let state = ChatState::new()?;
        
        Ok(AgentChatUI { state })
    }

    pub async fn run(&mut self) -> Result<()> {
        // Refresh available tools at startup
        self.state.refresh_tools_sync()?;

        let mut siv = Cursive::default();
        
        // Set up the UI layout
        self.setup_ui(&mut siv);

        // Add initial welcome message
        self.state.add_message(ChatMessage::System("Welcome to OSVM Agent Chat! ü§ñ".to_string()));
        self.state.add_message(ChatMessage::System("I can help you with blockchain operations using connected MCP tools.".to_string()));
        
        // Show available tools
        {
            let tools = self.state.available_tools.lock().unwrap();
            if tools.is_empty() {
                self.state.add_message(ChatMessage::System("No MCP servers are currently configured. Use 'osvm mcp setup' to get started.".to_string()));
            } else {
                let server_names: Vec<String> = tools.keys().cloned().collect();
                self.state.add_message(ChatMessage::System(format!("Available MCP servers: {}", server_names.join(", "))));
            }
        }

        // Update the chat display
        self.update_chat_display(&mut siv);

        // Run the TUI
        siv.run();

        Ok(())
    }

    fn setup_ui(&self, siv: &mut Cursive) {
        let state = self.state.clone();

        // Create the main layout
        let mut main_layout = LinearLayout::vertical();

        // Chat display area (scrollable)
        let chat_view = ScrollView::new(
            TextView::new("")
                .with_name("chat_display")
                .full_width()
        ).scroll_strategy(cursive::view::scroll::ScrollStrategy::StickToBottom)
         .with_name("chat_scroll");

        let chat_panel = Panel::new(chat_view)
            .title("Agent Chat")
            .title_position(cursive::align::HAlign::Left);

        // Input area
        let input_layout = LinearLayout::horizontal()
            .child(TextView::new("You: "))
            .child(
                EditView::new()
                    .on_submit({
                        let state = state.clone();
                        move |siv, text| {
                            handle_user_input(siv, text, state.clone());
                        }
                    })
                    .with_name("input")
                    .full_width()
            );

        let input_panel = Panel::new(input_layout).title("Input");

        // Tool status area
        let tools_view = TextView::new("")
            .with_name("tools_display")
            .full_width();
        
        let tools_panel = Panel::new(tools_view)
            .title("Available Tools")
            .title_position(cursive::align::HAlign::Left)
            .max_height(8);

        // Control buttons
        let button_layout = LinearLayout::horizontal()
            .child(Button::new("Refresh Tools", {
                let state = state.clone();
                move |siv| {
                    refresh_tools_handler(siv, state.clone());
                }
            }))
            .child(Button::new("Clear Chat", {
                let state = state.clone();
                move |siv| {
                    clear_chat_handler(siv, state.clone());
                }
            }))
            .child(Button::new("Help", show_help))
            .child(Button::new("Quit", |siv| siv.quit()));

        // Assemble the main layout
        main_layout.add_child(chat_panel.full_height());
        main_layout.add_child(tools_panel);
        main_layout.add_child(input_panel);
        main_layout.add_child(button_layout);

        // Wrap in a dialog for the window frame
        let dialog = Dialog::around(main_layout)
            .title("OSVM Agent Chat Interface")
            .title_position(cursive::align::HAlign::Center);

        siv.add_fullscreen_layer(dialog);

        // Set focus to the input field
        siv.focus_name("input").ok();

        // Update displays
        self.update_tools_display(siv);
    }

    fn update_chat_display(&self, siv: &mut Cursive) {
        let messages = self.get_messages();
        let mut display_text = String::new();

        for message in messages {
            match message {
                ChatMessage::User(text) => {
                    display_text.push_str(&format!("üë§ You: {}\n\n", text));
                }
                ChatMessage::Agent(text) => {
                    display_text.push_str(&format!("ü§ñ Agent: {}\n\n", text));
                }
                ChatMessage::System(text) => {
                    display_text.push_str(&format!("‚ÑπÔ∏è  System: {}\n\n", text));
                }
                ChatMessage::ToolCall(tool_name, description, args) => {
                    display_text.push_str(&format!("üîß Calling tool: {} - {}\n", tool_name, description));
                    if let Some(args) = args {
                        display_text.push_str(&format!("   Args: {}\n\n", args));
                    } else {
                        display_text.push_str("\n");
                    }
                }
                ChatMessage::ToolResult(tool_name, result) => {
                    display_text.push_str(&format!("‚úÖ Tool {} result:\n{}\n\n", tool_name, 
                        serde_json::to_string_pretty(&result).unwrap_or_else(|_| format!("{}", result))));
                }
                ChatMessage::Error(text) => {
                    display_text.push_str(&format!("‚ùå Error: {}\n\n", text));
                }
            }
        }

        if let Some(mut chat_display) = siv.find_name::<TextView>("chat_display") {
            chat_display.set_content(display_text);
        }
    }

    fn update_tools_display(&self, siv: &mut Cursive) {
        let tools = self.state.available_tools.lock().unwrap();
        let mut tools_text = String::new();

        if tools.is_empty() {
            tools_text.push_str("No MCP servers configured. Use 'osvm mcp setup' to add tools.");
        } else {
            for (server_id, server_tools) in tools.iter() {
                tools_text.push_str(&format!("üîå {}: ", server_id));
                let tool_names: Vec<String> = server_tools.iter().map(|t| t.name.clone()).collect();
                tools_text.push_str(&tool_names.join(", "));
                tools_text.push('\n');
            }
        }

        if let Some(mut tools_display) = siv.find_name::<TextView>("tools_display") {
            tools_display.set_content(tools_text);
        }
    }

    fn get_messages(&self) -> Vec<ChatMessage> {
        self.state.get_messages()
    }
}

/// Handle user input from the chat interface
fn handle_user_input(siv: &mut Cursive, text: &str, state: ChatState) {
    if text.trim().is_empty() {
        return;
    }

    // Add user message
    state.add_message(ChatMessage::User(text.to_string()));

    // Clear input
    if let Some(mut input) = siv.find_name::<EditView>("input") {
        input.set_content("");
    }

    // Update chat display
    update_chat_display_handler(siv, state.clone());

    // Process the user's message (this would be where we integrate AI/MCP logic)
    process_user_message(siv, text.to_string(), state);
}

/// Process user message and determine appropriate response/tool calls
fn process_user_message(siv: &mut Cursive, message: String, state: ChatState) {
    // This is a simplified version - in a full implementation, this would integrate
    // with an AI service to understand the user's intent and call appropriate tools
    
    // For now, we'll implement some basic commands and tool detection
    let message_lower = message.to_lowercase();
    
    if message_lower.contains("help") {
        state.add_message(ChatMessage::Agent("I can help you with blockchain operations using MCP tools. Try asking about account balances, transactions, or network status.".to_string()));
    } else if message_lower.contains("tools") || message_lower.contains("what can you do") {
        let tools = state.available_tools.lock().unwrap();
        if tools.is_empty() {
            state.add_message(ChatMessage::Agent("I don't have any MCP tools configured. Please configure some MCP servers first.".to_string()));
        } else {
            let mut response = "I have access to these tools:\n\n".to_string();
            for (server_id, server_tools) in tools.iter() {
                response.push_str(&format!("From {}:\n", server_id));
                for tool in server_tools {
                    response.push_str(&format!("  ‚Ä¢ {}: {}\n", tool.name, 
                        tool.description.as_deref().unwrap_or("No description")));
                }
                response.push('\n');
            }
            state.add_message(ChatMessage::Agent(response));
        }
    } else {
        // Default response for now
        state.add_message(ChatMessage::Agent("I understand you're asking about blockchain operations. In a full implementation, I would analyze your request and call appropriate MCP tools to help you.".to_string()));
    }

    // Update display
    update_chat_display_handler(siv, state);
}

/// Update chat display helper
fn update_chat_display_handler(siv: &mut Cursive, state: ChatState) {
    let messages = state.get_messages();
    let mut display_text = String::new();

    for message in messages {
        match message {
            ChatMessage::User(text) => {
                display_text.push_str(&format!("üë§ You: {}\n\n", text));
            }
            ChatMessage::Agent(text) => {
                display_text.push_str(&format!("ü§ñ Agent: {}\n\n", text));
            }
            ChatMessage::System(text) => {
                display_text.push_str(&format!("‚ÑπÔ∏è  System: {}\n\n", text));
            }
            ChatMessage::ToolCall(tool_name, description, args) => {
                display_text.push_str(&format!("üîß Calling tool: {} - {}\n", tool_name, description));
                if let Some(args) = args {
                    display_text.push_str(&format!("   Args: {}\n\n", args));
                } else {
                    display_text.push_str("\n");
                }
            }
            ChatMessage::ToolResult(tool_name, result) => {
                display_text.push_str(&format!("‚úÖ Tool {} result:\n{}\n\n", tool_name, 
                    serde_json::to_string_pretty(&result).unwrap_or_else(|_| format!("{}", result))));
            }
            ChatMessage::Error(text) => {
                display_text.push_str(&format!("‚ùå Error: {}\n\n", text));
            }
        }
    }

    if let Some(mut chat_display) = siv.find_name::<TextView>("chat_display") {
        chat_display.set_content(display_text);
    }
}

/// Refresh tools handler
fn refresh_tools_handler(siv: &mut Cursive, state: ChatState) {
    // In a real implementation, this would be async
    state.add_message(ChatMessage::System("Refreshing available tools...".to_string()));
    update_chat_display_handler(siv, state.clone());
    
    // For now, just update the tools display
    update_tools_display_handler(siv, state);
}

/// Clear chat handler
fn clear_chat_handler(siv: &mut Cursive, state: ChatState) {
    {
        let mut messages = state.messages.lock().unwrap();
        messages.clear();
    }
    
    // Add welcome message back
    state.add_message(ChatMessage::System("Chat cleared. Welcome back! ü§ñ".to_string()));
    update_chat_display_handler(siv, state);
}

/// Update tools display helper
fn update_tools_display_handler(siv: &mut Cursive, state: ChatState) {
    let tools = state.available_tools.lock().unwrap();
    let mut tools_text = String::new();

    if tools.is_empty() {
        tools_text.push_str("No MCP servers configured. Use 'osvm mcp setup' to add tools.");
    } else {
        for (server_id, server_tools) in tools.iter() {
            tools_text.push_str(&format!("üîå {}: ", server_id));
            if server_tools.is_empty() {
                tools_text.push_str("Available (tools not fetched)");
            } else {
                let tool_names: Vec<String> = server_tools.iter().map(|t| t.name.clone()).collect();
                tools_text.push_str(&tool_names.join(", "));
            }
            tools_text.push('\n');
        }
    }

    if let Some(mut tools_display) = siv.find_name::<TextView>("tools_display") {
        tools_display.set_content(tools_text);
    }
}

/// Show help dialog
fn show_help(siv: &mut Cursive) {
    let help_text = "OSVM Agent Chat Help\n\n\
        ‚Ä¢ Type your questions or requests in the input box\n\
        ‚Ä¢ Press Enter to send messages\n\
        ‚Ä¢ Ask about blockchain operations, accounts, transactions\n\
        ‚Ä¢ Say 'tools' to see available MCP tools\n\
        ‚Ä¢ Use 'Refresh Tools' to reload available tools\n\
        ‚Ä¢ Use 'Clear Chat' to start fresh\n\
        ‚Ä¢ Press 'Quit' or Ctrl+C to exit\n\n\
        The agent will use MCP tools to help with your requests.";

    siv.add_layer(
        Dialog::text(help_text)
            .title("Help")
            .button("OK", |s| {
                s.pop_layer();
            })
    );
}

/// Main entry point for the agent chat UI
pub async fn run_agent_chat() -> Result<()> {
    println!("üöÄ Starting OSVM Agent Chat Interface...");
    
    // Check if we're in a terminal environment
    if std::env::var("TERM").is_err() || std::env::var("CI").is_ok() {
        return run_demo_mode().await;
    }
    
    let mut chat_ui = AgentChatUI::new()
        .context("Failed to initialize chat UI")?;
    
    chat_ui.run().await
        .context("Failed to run chat interface")?;

    Ok(())
}

/// Run comprehensive UI testing and demonstration
pub async fn run_chat_ui_tests() -> Result<()> {
    println!("üß™ OSVM Agent Chat UI - Comprehensive Testing & Screenshots");
    println!("==========================================================");
    println!();

    // Test 1: Basic functionality
    println!("üìã Test 1: Basic Functionality");
    test_chat_state_management().await?;
    println!();

    // Test 2: MCP Integration
    println!("üìã Test 2: MCP Server Integration");  
    test_mcp_integration().await?;
    println!();

    // Test 3: UI Layout Mockups
    println!("üìã Test 3: UI Layout Demonstrations");
    show_ui_layout_mockups().await?;
    println!();

    // Test 4: Interaction Scenarios
    println!("üìã Test 4: Chat Interaction Scenarios");
    test_interaction_scenarios().await?;
    println!();

    println!("‚úÖ All tests completed successfully!");
    println!("üì∏ Screenshots and demonstrations above show the chat UI capabilities.");

    Ok(())
}

/// Test chat state management and message handling
async fn test_chat_state_management() -> Result<()> {
    let state = ChatState::new()?;
    
    println!("   ‚úÖ Chat state initialized");
    
    // Add sample messages
    state.add_message(ChatMessage::System("Chat system initialized".to_string()));
    state.add_message(ChatMessage::User("Hello, what can you do?".to_string()));
    state.add_message(ChatMessage::Agent("I can help you with blockchain operations using MCP tools.".to_string()));
    state.add_message(ChatMessage::ToolCall("get_balance".to_string(), "Check wallet balance".to_string(), None));
    state.add_message(ChatMessage::ToolResult("get_balance".to_string(), serde_json::json!({"balance": "2.5 SOL"})));
    
    let messages = state.get_messages();
    println!("   ‚úÖ Message handling: {} messages stored", messages.len());
    
    // Test tool refresh
    state.refresh_tools_sync()?;
    println!("   ‚úÖ Tool refresh functionality");
    
    Ok(())
}

/// Test MCP server integration
async fn test_mcp_integration() -> Result<()> {
    let mut mcp_service = crate::services::mcp_service::McpService::new_with_debug(false);
    
    println!("   üîç Testing MCP service integration...");
    
    // Try to load config
    match mcp_service.load_config() {
        Ok(()) => {
            let servers = mcp_service.list_servers();
            println!("   ‚úÖ MCP config loaded: {} servers", servers.len());
            
            for (server_id, config) in servers {
                let status = if config.enabled { "üü¢" } else { "üî¥" };
                println!("      {} {}: {}", status, server_id, config.url);
            }
        }
        Err(_) => {
            println!("   ‚ö†Ô∏è  No MCP config found - this is normal for fresh installations");
            println!("      Users can run 'osvm mcp setup' to configure servers");
        }
    }
    
    Ok(())
}

/// Show detailed UI layout mockups
async fn show_ui_layout_mockups() -> Result<()> {
    println!("   üé® Cursive-Multiplex Layout Demonstration:");
    println!();
    
    // Main layout
    println!("   ‚îå‚îÄ OSVM Agent Chat Interface (cursive-multiplex) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
    println!("   ‚îÇ                                                                     ‚îÇ");
    println!("   ‚îÇ  ‚îå‚îÄ Chat History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ MCP Tools Panel ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ");
    println!("   ‚îÇ  ‚îÇ ‚ÑπÔ∏è  System: Welcome to OSVM Chat!      ‚îÇ ‚îÇ üîå Connected Servers ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ                                        ‚îÇ ‚îÇ   ‚Ä¢ solana-mcp      ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ üë§ You: What's my wallet balance?      ‚îÇ ‚îÇ   ‚Ä¢ custom-server   ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ                                        ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ ü§ñ Agent: I'll check your balance     ‚îÇ ‚îÇ üõ†Ô∏è  Available Tools   ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ   using Solana MCP tools...           ‚îÇ ‚îÇ   ‚Ä¢ get_balance     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ                                        ‚îÇ ‚îÇ   ‚Ä¢ get_txns        ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ üîß Calling tool: get_balance          ‚îÇ ‚îÇ   ‚Ä¢ send_tx          ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ    Args: {{\"address\": \"7x4...\"}}       ‚îÇ ‚îÇ   ‚Ä¢ stake_info      ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ                                        ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ ‚úÖ Tool get_balance result:            ‚îÇ ‚îÇ üìä Server Status    ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ    {{\"balance\": \"2.5 SOL\"}}             ‚îÇ ‚îÇ   üü¢ All Online     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ                                        ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ ü§ñ Agent: Your wallet balance is      ‚îÇ ‚îÇ üîÑ Last Refresh     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ   2.5 SOL (~$250 USD)                 ‚îÇ ‚îÇ   2 seconds ago     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ                                        ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ üë§ You: Show recent transactions      ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ                                        ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ ü§ñ Agent: Fetching your transaction   ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îÇ   history...                          ‚îÇ ‚îÇ                     ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ");
    println!("   ‚îÇ                                                                     ‚îÇ");
    println!("   ‚îÇ  ‚îå‚îÄ Input Area ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ");
    println!("   ‚îÇ  ‚îÇ You: [Type your message here...                    ] [Send]    ‚îÇ ‚îÇ");
    println!("   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ");
    println!("   ‚îÇ                                                                     ‚îÇ");
    println!("   ‚îÇ  [üîÑ Refresh Tools] [üßπ Clear Chat] [‚ùì Help] [‚ùå Quit]               ‚îÇ");
    println!("   ‚îÇ                                                                     ‚îÇ");
    println!("   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
    println!();
    
    // Alternative compact layout
    println!("   üé® Alternative Compact Layout:");
    println!();
    println!("   ‚îå‚îÄ OSVM Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
    println!("   ‚îÇ üë§ You: Check my staking rewards                                   ‚îÇ");
    println!("   ‚îÇ ü§ñ Agent: I'll check your staking information...                  ‚îÇ");
    println!("   ‚îÇ üîß [get_stake_accounts] ‚Üí ‚úÖ Found 2 stake accounts               ‚îÇ");
    println!("   ‚îÇ ü§ñ Agent: You have 10 SOL staked earning 6.8% APY                ‚îÇ");
    println!("   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
    println!("   ‚îÇ Input: [_] | Tools: 8 available | Servers: 2 online | Help: F1    ‚îÇ");
    println!("   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
    
    Ok(())
}

/// Test different chat interaction scenarios
async fn test_interaction_scenarios() -> Result<()> {
    println!("   üé≠ Scenario Testing:");
    println!();
    
    // Scenario 1: New user onboarding
    println!("   üìù Scenario 1: New User Onboarding");
    println!("      üë§ User: [First time opening chat]");
    println!("      ‚ÑπÔ∏è  System: Welcome to OSVM Agent Chat! ü§ñ");
    println!("      ‚ÑπÔ∏è  System: I can help you with blockchain operations using MCP tools.");
    println!("      ‚ö†Ô∏è  System: No MCP servers configured. Use 'osvm mcp setup' to get started.");
    println!("      üí° System: Try saying 'help' to see what I can do!");
    println!();
    
    // Scenario 2: Help command
    println!("   üìù Scenario 2: Help System");
    println!("      üë§ User: help");
    println!("      ü§ñ Agent: I can help you with blockchain operations using MCP tools.");
    println!("              Available commands:");
    println!("              ‚Ä¢ 'tools' - Show available MCP tools");
    println!("              ‚Ä¢ 'balance' - Check wallet balance");
    println!("              ‚Ä¢ 'transactions' - View recent transactions");
    println!("              ‚Ä¢ 'help' - Show this help message");
    println!();
    
    // Scenario 3: Error handling
    println!("   üìù Scenario 3: Error Handling");
    println!("      üë§ User: Check balance of invalid_address");
    println!("      ü§ñ Agent: I'll check that address...");
    println!("      üîß [get_balance] with address: invalid_address");
    println!("      ‚ùå Error: Invalid address format");
    println!("      ü§ñ Agent: I encountered an error: Invalid address format.");
    println!("              Please provide a valid Solana address (base58 encoded).");
    println!();
    
    // Scenario 4: Multi-step operation
    println!("   üìù Scenario 4: Multi-step Operations");
    println!("      üë§ User: I want to send 1 SOL to my friend");
    println!("      ü§ñ Agent: I'll help you send SOL. First, let me check your balance...");
    println!("      üîß [get_balance] ‚Üí ‚úÖ Balance: 5.2 SOL");
    println!("      ü§ñ Agent: You have 5.2 SOL available. What's the recipient address?");
    println!("      üë§ User: 7x4B2vKj9x8F3qY2mN5pL1sA6hR9....");
    println!("      ü§ñ Agent: Thanks! Preparing to send 1 SOL to 7x4B2v...");
    println!("      üîß [send_transaction] ‚Üí ‚úÖ Transaction sent: abc123...");
    println!("      ü§ñ Agent: Successfully sent 1 SOL! Transaction: abc123...");
    println!();
    
    println!("   ‚úÖ All interaction scenarios tested successfully!");
    
    Ok(())
}

/// Run demo mode for non-terminal environments
async fn run_demo_mode() -> Result<()> {
    println!("üì± Running in enhanced demo mode (terminal UI not available)");
    println!();

    // Initialize chat state to show MCP integration
    let state = ChatState::new()?;
    state.refresh_tools_sync()?;
    
    // Show what the interface provides
    println!("üéØ OSVM Agent Chat Interface Features:");
    println!("   ‚Ä¢ Interactive chat interface using cursive-multiplex");
    println!("   ‚Ä¢ Integration with configured MCP servers");
    println!("   ‚Ä¢ Real-time tool calling and blockchain operations");
    println!("   ‚Ä¢ Multi-panel layout with chat history and tool status");
    println!();

    // Show detailed UI layout description
    println!("üñºÔ∏è  Chat Interface Layout:");
    println!("   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
    println!("   ‚îÇ                OSVM Agent Chat                  ‚îÇ");
    println!("   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
    println!("   ‚îÇ  Chat History                     ‚îÇ Tools Panel ‚îÇ");
    println!("   ‚îÇ  üë§ User: What's my balance?      ‚îÇ üîå Servers: ‚îÇ");
    println!("   ‚îÇ  ü§ñ Agent: Checking balance...    ‚îÇ   ‚Ä¢ solana  ‚îÇ");
    println!("   ‚îÇ  üîß Calling: get_balance         ‚îÇ   ‚Ä¢ test-srv‚îÇ");
    println!("   ‚îÇ  ‚úÖ Result: 2.5 SOL              ‚îÇ üõ†Ô∏è  Tools:   ‚îÇ");
    println!("   ‚îÇ  üë§ User: Show transactions      ‚îÇ   ‚Ä¢ balance ‚îÇ");
    println!("   ‚îÇ  ü§ñ Agent: Fetching txns...       ‚îÇ   ‚Ä¢ tx_list ‚îÇ");
    println!("   ‚îÇ                                   ‚îÇ   ‚Ä¢ send    ‚îÇ");
    println!("   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
    println!("   ‚îÇ Input: [Type your message here...] [Send]      ‚îÇ");
    println!("   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§");
    println!("   ‚îÇ [Refresh Tools] [Clear] [Help] [Quit]          ‚îÇ");
    println!("   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
    println!();

    // Show MCP server status with more detail
    let tools = state.available_tools.lock().unwrap();
    if tools.is_empty() {
        println!("‚ö†Ô∏è  No MCP servers configured.");
        println!("   üì• To set up MCP servers:");
        println!("      1. osvm mcp setup                    # Quick Solana setup");
        println!("      2. osvm mcp add custom --server-url <url> --enabled");
        println!("      3. osvm mcp list                     # View configured servers");
    } else {
        println!("üîå MCP Server Integration Status:");
        for (server_id, server_tools) in tools.iter() {
            println!("   ‚úÖ {}: Connected & Available", server_id);
            println!("      ‚îî‚îÄ Tools would be dynamically loaded in interactive mode");
        }
        
        // Simulate tool loading
        println!();
        println!("üìä Simulated Tool Discovery:");
        for (server_id, _) in tools.iter() {
            println!("   üîç Discovering tools from '{}'...", server_id);
            println!("      ‚îî‚îÄ Found: get_balance, get_transactions, send_transaction");
            println!("      ‚îî‚îÄ Status: Ready for chat interactions");
        }
    }
    
    println!();
    println!("üí≠ Interactive Chat Examples:");
    
    // Example 1: Balance Check
    println!("   ‚îå‚îÄ‚îÄ Example 1: Balance Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
    println!("   ‚îÇ üë§ User: What's the balance of my wallet?        ‚îÇ");
    println!("   ‚îÇ ü§ñ Agent: I'll check your wallet balance using   ‚îÇ");
    println!("   ‚îÇ           the Solana MCP tools...                ‚îÇ");
    println!("   ‚îÇ üîß [Tool Call] solana_get_balance(               ‚îÇ");
    println!("   ‚îÇ      address: \"<your-wallet-address>\"            ‚îÇ");
    println!("   ‚îÇ    )                                              ‚îÇ");
    println!("   ‚îÇ ‚úÖ [Result] Balance: 2.5 SOL (~$250 USD)         ‚îÇ");
    println!("   ‚îÇ ü§ñ Agent: Your current wallet balance is 2.5 SOL ‚îÇ");
    println!("   ‚îÇ           which is approximately $250 USD.       ‚îÇ");
    println!("   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
    println!();
    
    // Example 2: Transaction History
    println!("   ‚îå‚îÄ‚îÄ Example 2: Transaction History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
    println!("   ‚îÇ üë§ User: Show me my recent transactions          ‚îÇ");
    println!("   ‚îÇ ü§ñ Agent: I'll fetch your recent transaction     ‚îÇ");
    println!("   ‚îÇ           history...                             ‚îÇ");
    println!("   ‚îÇ üîß [Tool Call] solana_get_signatures(            ‚îÇ");
    println!("   ‚îÇ      address: \"<wallet>\", limit: 10             ‚îÇ");
    println!("   ‚îÇ    )                                              ‚îÇ");
    println!("   ‚îÇ ‚úÖ [Result] Found 5 recent transactions:         ‚îÇ");
    println!("   ‚îÇ    ‚Ä¢ 2025-01-15: Sent 0.1 SOL to ...abc123     ‚îÇ");
    println!("   ‚îÇ    ‚Ä¢ 2025-01-14: Received 1.0 SOL from ...def456‚îÇ");
    println!("   ‚îÇ    ‚Ä¢ 2025-01-13: Staked 5.0 SOL                 ‚îÇ");
    println!("   ‚îÇ ü§ñ Agent: Here are your 5 most recent           ‚îÇ");
    println!("   ‚îÇ           transactions: [formatted list above]   ‚îÇ");
    println!("   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
    println!();
    
    // Example 3: Complex Query
    println!("   ‚îå‚îÄ‚îÄ Example 3: Complex Query ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê");
    println!("   ‚îÇ üë§ User: What's the current Solana network       ‚îÇ");
    println!("   ‚îÇ         status and my staking rewards?           ‚îÇ");
    println!("   ‚îÇ ü§ñ Agent: I'll check both network health and     ‚îÇ");
    println!("   ‚îÇ           your staking information...            ‚îÇ");
    println!("   ‚îÇ üîß [Tool Call] solana_get_cluster_info()         ‚îÇ");
    println!("   ‚îÇ üîß [Tool Call] solana_get_stake_accounts(        ‚îÇ");
    println!("   ‚îÇ      address: \"<wallet>\"                        ‚îÇ");
    println!("   ‚îÇ    )                                              ‚îÇ");
    println!("   ‚îÇ ‚úÖ [Results] Network: Healthy, Slot: 245M        ‚îÇ");
    println!("   ‚îÇ             Staking: 10 SOL earning 6.8% APY    ‚îÇ");
    println!("   ‚îÇ ü§ñ Agent: Solana network is healthy at slot     ‚îÇ");
    println!("   ‚îÇ           245M. You have 10 SOL staked earning   ‚îÇ");
    println!("   ‚îÇ           6.8% APY with rewards every epoch.     ‚îÇ");
    println!("   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò");
    println!();

    // Technical details
    println!("‚öôÔ∏è  Technical Implementation:");
    println!("   ‚Ä¢ Framework: cursive-multiplex for advanced TUI layout");
    println!("   ‚Ä¢ MCP Integration: Discovers tools from configured servers");
    println!("   ‚Ä¢ Real-time Updates: Live tool status and server health");
    println!("   ‚Ä¢ Error Handling: Graceful fallbacks for network issues");
    println!("   ‚Ä¢ State Management: Persistent chat history and configs");
    println!();

    // Advanced features
    println!("üöÄ Advanced Features:");
    println!("   ‚Ä¢ Tab completion for commands and addresses");
    println!("   ‚Ä¢ History navigation with up/down arrows");
    println!("   ‚Ä¢ Syntax highlighting for blockchain data");
    println!("   ‚Ä¢ Export chat history to file");
    println!("   ‚Ä¢ Custom MCP tool configuration");
    println!("   ‚Ä¢ Multi-network support (mainnet/testnet/devnet)");
    println!();

    println!("üíª To experience the full interactive interface:");
    println!("   Run 'osvm chat' in a proper terminal environment");
    println!("   (xterm, gnome-terminal, iTerm2, etc.)");
    println!();
    
    // Show current configuration
    print_configuration_status().await?;

    Ok(())
}

/// Print current MCP and system configuration status
async fn print_configuration_status() -> Result<()> {
    println!("üìã Current System Configuration:");
    
    // Try to load MCP service to check configuration
    let mut mcp_service = crate::services::mcp_service::McpService::new_with_debug(false);
    match mcp_service.load_config() {
        Ok(()) => {
            let servers = mcp_service.list_servers();
            println!("   ‚úÖ MCP Configuration: Loaded");
            println!("      ‚îî‚îÄ {} server(s) configured", servers.len());
            for (server_id, config) in servers {
                let status = if config.enabled { "üü¢ Enabled" } else { "üî¥ Disabled" };
                println!("      ‚îî‚îÄ {}: {} ({})", server_id, config.url, status);
            }
        }
        Err(e) => {
            println!("   ‚ö†Ô∏è  MCP Configuration: Not loaded ({:?})", e);
            println!("      ‚îî‚îÄ Run 'osvm mcp setup' to configure");
        }
    }
    
    println!("   üìÅ Config Directory: ~/.config/osvm/");
    println!("   üîó Default Network: Mainnet");
    println!("   üé® UI Theme: OSVM Blueprint");
    
    Ok(())
}