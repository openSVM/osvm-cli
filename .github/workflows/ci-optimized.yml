name: CI Optimized

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Quick sanity checks (no build)
  sanity-check:
    name: Sanity Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libhidapi-dev libudev-dev pkg-config libssl-dev perl

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-sanity-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features

  # Build debug and release binaries once
  build:
    name: Build Binaries
    needs: sanity-check
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libhidapi-dev libudev-dev pkg-config libssl-dev perl

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          profile: minimal
          toolchain: stable

      - name: Generate cache key
        id: cache-key
        run: |
          KEY="${{ runner.os }}-build-${{ hashFiles('**/Cargo.lock') }}-${{ github.sha }}"
          echo "key=${KEY}" >> $GITHUB_OUTPUT

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-build-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-build-

      - name: Build debug binary
        run: cargo build --locked

      - name: Build release binary
        run: cargo build --release --locked

      - name: Upload debug binary
        uses: actions/upload-artifact@v4
        with:
          name: osvm-debug
          path: target/debug/osvm
          retention-days: 1

      - name: Upload release binary
        uses: actions/upload-artifact@v4
        with:
          name: osvm-release
          path: target/release/osvm
          retention-days: 1

  # Unit tests (reuse debug build)
  unit-tests:
    name: Unit Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libhidapi-dev libudev-dev pkg-config libssl-dev perl

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          profile: minimal
          toolchain: stable

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ needs.build.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Install Solana CLI tools
        run: |
          curl --proto '=https' --tlsv1.2 -sSfL https://solana-install.solana.workers.dev | bash
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Generate default signer
        run: |
          mkdir -p $HOME/.config/solana
          solana-keygen new --no-bip39-passphrase -o $HOME/.config/solana/id.json

      - name: Run unit tests
        run: cargo test --lib --bins

  # E2E tests (reuse release build)
  e2e-tests:
    name: End-to-End Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libhidapi-dev libudev-dev pkg-config libssl-dev perl

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          profile: minimal
          toolchain: stable

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ needs.build.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Install Solana CLI tools
        run: |
          curl --proto '=https' --tlsv1.2 -sSfL https://solana-install.solana.workers.dev | bash
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Generate default signer
        run: |
          mkdir -p $HOME/.config/solana
          solana-keygen new --no-bip39-passphrase -o $HOME/.config/solana/id.json

      - name: Run e2e tests
        run: cargo test --test main

  # OVSM tests (parallel with main tests, reuse cache)
  ovsm-tests:
    name: OVSM Crate Tests
    needs: sanity-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          profile: minimal
          toolchain: stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-ovsm-${{ hashFiles('**/Cargo.lock') }}

      - name: Build OVSM crate
        run: cargo build --release
        working-directory: crates/ovsm

      - name: Run OVSM unit tests
        run: cargo test --lib --bins
        working-directory: crates/ovsm

      - name: Run OVSM integration tests
        run: cargo test
        working-directory: crates/ovsm

      - name: Upload OVSM binary
        uses: actions/upload-artifact@v4
        with:
          name: ovsm-lib
          path: target/release/libovsm.*
          retention-days: 1
          if-no-files-found: ignore

  # Integration tests (reuse release build)
  integration-tests:
    name: Integration Tests
    needs: [build, ovsm-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libhidapi-dev libudev-dev pkg-config libssl-dev perl

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ needs.build.outputs.cache-key }}

      - name: Install Solana CLI tools
        run: |
          curl --proto '=https' --tlsv1.2 -sSfL https://solana-install.solana.workers.dev | bash
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Generate default signer
        run: |
          mkdir -p $HOME/.config/solana
          solana-keygen new --no-bip39-passphrase -o $HOME/.config/solana/id.json

      - name: Run all integration tests
        run: |
          cargo test --test ovsm_integration_tests
          cargo test --test chat_complex_multi_step_plan_test
          cargo test --test chat_keyboard_test

  # Code coverage (only after all tests pass)
  code-coverage:
    name: Code Coverage
    needs: [unit-tests, e2e-tests, ovsm-tests, integration-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libhidapi-dev libudev-dev pkg-config libssl-dev perl

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage (main crate)
        run: |
          mkdir -p coverage
          cargo tarpaulin --out Xml --output-dir coverage --lib --bins --timeout 600

      - name: Generate coverage (OVSM crate)
        run: |
          mkdir -p coverage
          cargo tarpaulin --out Xml --output-dir coverage --lib --bins --timeout 600
        working-directory: crates/ovsm

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/cobertura.xml,./crates/ovsm/coverage/cobertura.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # Summary job
  ci-success:
    name: CI Success
    needs: [sanity-check, build, unit-tests, e2e-tests, ovsm-tests, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.sanity-check.result }}" != "success" ]]; then
            echo "Sanity checks failed"
            exit 1
          fi
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "Build failed"
            exit 1
          fi
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "Unit tests failed"
            exit 1
          fi
          if [[ "${{ needs.e2e-tests.result }}" != "success" ]]; then
            echo "E2E tests failed"
            exit 1
          fi
          if [[ "${{ needs.ovsm-tests.result }}" != "success" ]]; then
            echo "OVSM tests failed"
            exit 1
          fi
          if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "Integration tests failed"
            exit 1
          fi
          echo "âœ… All CI checks passed!"
